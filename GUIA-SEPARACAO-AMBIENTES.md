# üèóÔ∏è Guia Completo: Separa√ß√£o de Ambientes Dev/Staging/Produ√ß√£o

**Data:** 16/09/2025  
**Objetivo:** Separar ambientes para desenvolvimento seguro  
**Status:** Guia de Implementa√ß√£o Completo  

---

## üìã Situa√ß√£o Atual vs. Ideal

### ‚ùå **SITUA√á√ÉO ATUAL (Problem√°tica):**
```
Desenvolvimento Local ‚Üí Banco "dropa" (Supabase)
Produ√ß√£o Vercel     ‚Üí Banco "dropa" (Supabase)
```
**Problemas:**
- Mudan√ßas de dev afetam produ√ß√£o
- Testes podem quebrar dados reais
- Rollback complexo
- Risco de corrup√ß√£o de dados

### ‚úÖ **SITUA√á√ÉO IDEAL (Objetivo):**
```
Desenvolvimento Local ‚Üí Banco "dropa-staging" (Supabase)
Staging Vercel       ‚Üí Banco "dropa-staging" (Supabase)
Produ√ß√£o Vercel      ‚Üí Banco "dropa" (Supabase)
```

---

## üéØ Arquitetura de Ambientes Recomendada

### **1. DESENVOLVIMENTO (Local)**
- **Banco:** `dropa-staging` (Supabase)
- **Branch:** `develop` ou `main` local
- **Prop√≥sito:** Desenvolvimento di√°rio, testes locais

### **2. STAGING (Vercel)**
- **Banco:** `dropa-staging` (Supabase)
- **Branch:** `staging` ‚Üí Deploy autom√°tico
- **URL:** `dropa-colecion-veis-staging.vercel.app`
- **Prop√≥sito:** Testes finais, homologa√ß√£o

### **3. PRODU√á√ÉO (Vercel)**
- **Banco:** `dropa` (Supabase)
- **Branch:** `main` ‚Üí Deploy autom√°tico
- **URL:** `dropa-colecion-veis.vercel.app`
- **Prop√≥sito:** Ambiente live dos usu√°rios

---

## üìö PASSO 1: Configura√ß√£o do Banco Staging

### **1.1 - Supabase: Configurar Banco Staging**

#### **Op√ß√£o A: Usar banco existente "dropa-staging"**
```sql
-- Conectar no banco dropa-staging
-- Verificar se j√° existe
SELECT current_database();
```

#### **Op√ß√£o B: Criar novo banco (se necess√°rio)**
1. Acessar Supabase Dashboard
2. Criar novo projeto: `dropa-staging`
3. Copiar credenciais de conex√£o

### **1.2 - Copiar Dados de Produ√ß√£o para Staging**

```bash
# 1. Fazer backup do banco de produ√ß√£o
pg_dump "postgresql://postgres.mahzeczsuklpnqstqqug:M%4022te24uss@aws-1-sa-east-1.pooler.supabase.com:5432/postgres" \
  --verbose \
  --no-owner \
  --no-privileges \
  --format=custom \
  --file="dropa-production-backup.sql"

# 2. Restaurar no banco de staging (substituir pela URL do staging)
pg_restore --verbose --clean --no-acl --no-owner \
  -h "sua-staging-host.supabase.co" \
  -p 5432 \
  -U postgres \
  -d postgres \
  "dropa-production-backup.sql"
```

---

## üìö PASSO 2: Estrat√©gia de Branches GitHub

### **2.1 - Estrutura de Branches Recomendada**

```
main (produ√ß√£o)
‚îú‚îÄ‚îÄ staging (homologa√ß√£o)
‚îú‚îÄ‚îÄ develop (desenvolvimento)
‚îú‚îÄ‚îÄ feature/nova-funcionalidade
‚îú‚îÄ‚îÄ hotfix/correcao-urgente
‚îî‚îÄ‚îÄ release/v1.2.0
```

### **2.2 - Configurar Branches**

```bash
# 1. Ir para o reposit√≥rio local
cd /mnt/c/Users/mateus.pereira/Desktop/colecionaveis/colecionaveis-platform

# 2. Verificar branch atual
git branch

# 3. Criar e configurar branch staging
git checkout -b staging
git push -u origin staging

# 4. Criar e configurar branch develop (opcional)
git checkout -b develop
git push -u origin develop

# 5. Voltar para main
git checkout main
```

### **2.3 - Configurar Protection Rules no GitHub**

1. **Ir para:** `Settings > Branches` no GitHub
2. **Adicionar regras para `main`:**
   - ‚úÖ Require pull request reviews
   - ‚úÖ Require status checks to pass
   - ‚úÖ Require branches to be up to date
   - ‚úÖ Restrict pushes

3. **Adicionar regras para `staging`:**
   - ‚úÖ Require pull request reviews (opcional)
   - ‚úÖ Allow force pushes (para testes)

---

## üìö PASSO 3: Configura√ß√£o de Vari√°veis de Ambiente

### **3.1 - Arquivo .env.local (Desenvolvimento)**

Criar arquivo `.env.local`:

```bash
# DEVELOPMENT ENVIRONMENT
NODE_ENV="development"

# Database Configuration - STAGING
DATABASE_URL="postgresql://postgres.staging:senha@staging-host.supabase.co:6543/postgres?pgbouncer=true&connection_limit=1"
DIRECT_URL="postgresql://postgres.staging:senha@staging-host.supabase.co:5432/postgres"

# NextAuth - Development
NEXTAUTH_URL="http://localhost:3000"
NEXTAUTH_SECRET="dev-secret-change-in-production"

# OAuth Providers - Development Keys
GOOGLE_CLIENT_ID="dev-google-client-id"
GOOGLE_CLIENT_SECRET="dev-google-client-secret"

# Mercado Pago - SANDBOX (Teste)
MERCADO_PAGO_ACCESS_TOKEN="TEST-123456789-sandbox-token"
MERCADO_PAGO_PUBLIC_KEY="TEST-pub-key-sandbox"
NEXT_PUBLIC_MERCADO_PAGO_PUBLIC_KEY="TEST-pub-key-sandbox"

# Email - Development
RESEND_API_KEY="dev-resend-key"

# Cloudinary - Development
CLOUDINARY_CLOUD_NAME="dev-cloud-name"
CLOUDINARY_API_KEY="dev-api-key"
CLOUDINARY_API_SECRET="dev-api-secret"

# Backup Configuration
BACKUP_DIR="./backups"
BACKUP_ENCRYPTION_KEY="Dev-Backup-Key-2025-Staging-Environment"
BACKUP_RETENTION_DAYS="30"
```

### **3.2 - Arquivo .env.staging**

Criar arquivo `.env.staging`:

```bash
# STAGING ENVIRONMENT
NODE_ENV="staging"

# Database Configuration - STAGING
DATABASE_URL="postgresql://postgres.staging:senha@staging-host.supabase.co:6543/postgres?pgbouncer=true&connection_limit=1"
DIRECT_URL="postgresql://postgres.staging:senha@staging-host.supabase.co:5432/postgres"

# NextAuth - Staging
NEXTAUTH_URL="https://dropa-colecion-veis-staging.vercel.app"
NEXTAUTH_SECRET="staging-secret-different-from-prod"

# OAuth Providers - Development/Test Keys
GOOGLE_CLIENT_ID="staging-google-client-id"
GOOGLE_CLIENT_SECRET="staging-google-client-secret"

# Mercado Pago - SANDBOX (Teste)
MERCADO_PAGO_ACCESS_TOKEN="TEST-123456789-sandbox-token"
MERCADO_PAGO_PUBLIC_KEY="TEST-pub-key-sandbox"
NEXT_PUBLIC_MERCADO_PAGO_PUBLIC_KEY="TEST-pub-key-sandbox"

# Email - Staging
RESEND_API_KEY="staging-resend-key"

# Cloudinary - Staging
CLOUDINARY_CLOUD_NAME="staging-cloud-name"
CLOUDINARY_API_KEY="staging-api-key"
CLOUDINARY_API_SECRET="staging-api-secret"

# Feature Flags
ENABLE_REGISTRATION="true"
ENABLE_MARKETPLACE="true"
ENABLE_ACHIEVEMENTS="true"
MAINTENANCE_MODE="false"
```

### **3.3 - Arquivo .env (Produ√ß√£o)**

Manter o arquivo `.env` atual para produ√ß√£o.

---

## üìö PASSO 4: Configura√ß√£o da Vercel

### **4.1 - Projeto Staging na Vercel**

#### **Configura√ß√µes do Projeto Staging:**

1. **Acessar:** `dropa-colecion-veis-staging` na Vercel
2. **Settings > Environment Variables**
3. **Configurar vari√°veis de staging:**

```
DATABASE_URL = postgresql://postgres.staging:senha@staging-host.supabase.co:6543/postgres?pgbouncer=true&connection_limit=1
DIRECT_URL = postgresql://postgres.staging:senha@staging-host.supabase.co:5432/postgres
NEXTAUTH_URL = https://dropa-colecion-veis-staging.vercel.app
NEXTAUTH_SECRET = staging-secret-different-from-prod
MERCADO_PAGO_ACCESS_TOKEN = TEST-123456789-sandbox-token
MERCADO_PAGO_PUBLIC_KEY = TEST-pub-key-sandbox
NEXT_PUBLIC_MERCADO_PAGO_PUBLIC_KEY = TEST-pub-key-sandbox
# ... outras vari√°veis conforme .env.staging
```

#### **Configurar Deploy Autom√°tico:**

1. **Settings > Git**
2. **Production Branch:** `staging`
3. **Deploy Hooks:** Configurar se necess√°rio

### **4.2 - Projeto Produ√ß√£o na Vercel**

#### **Verificar Configura√ß√µes:**

1. **Acessar:** `dropa-colecion-veis` na Vercel
2. **Settings > Environment Variables**
3. **Confirmar vari√°veis de produ√ß√£o:**

```
DATABASE_URL = postgresql://postgres.mahzeczsuklpnqstqqug:M%4022te24uss@aws-1-sa-east-1.pooler.supabase.com:6543/postgres?pgbouncer=true&connection_limit=1
NEXTAUTH_URL = https://dropa-colecion-veis.vercel.app
MERCADO_PAGO_ACCESS_TOKEN = APP_USR-5868743863758866-081912-cc1874933181897891fb3a1705745a0f-353925384
# ... vari√°veis de produ√ß√£o
```

#### **Configurar Deploy Autom√°tico:**

1. **Settings > Git**
2. **Production Branch:** `main`

---

## üìö PASSO 5: Workflow de Desenvolvimento

### **5.1 - Fluxo de Trabalho Di√°rio**

#### **Para Nova Funcionalidade:**

```bash
# 1. Come√ßar do develop
git checkout develop
git pull origin develop

# 2. Criar feature branch
git checkout -b feature/nova-funcionalidade

# 3. Desenvolver localmente (banco staging)
npm run dev
# Testar com banco dropa-staging

# 4. Commit e push
git add .
git commit -m "feat: adicionar nova funcionalidade"
git push origin feature/nova-funcionalidade

# 5. Pull Request para staging
# GitHub: feature/nova-funcionalidade ‚Üí staging

# 6. Testar em staging
# URL: https://dropa-colecion-veis-staging.vercel.app

# 7. Pull Request para produ√ß√£o (ap√≥s aprova√ß√£o)
# GitHub: staging ‚Üí main
```

#### **Para Hotfix:**

```bash
# 1. Come√ßar do main
git checkout main
git pull origin main

# 2. Criar hotfix branch
git checkout -b hotfix/correcao-urgente

# 3. Corrigir problema
# Testar localmente

# 4. Deploy direto para produ√ß√£o
git add .
git commit -m "fix: corrigir problema urgente"
git push origin hotfix/correcao-urgente

# 5. Pull Request para main (revis√£o r√°pida)
# 6. Merge para staging tamb√©m
```

### **5.2 - Comandos √öteis**

```bash
# Verificar ambiente atual
echo $NODE_ENV

# Sincronizar dados prod ‚Üí staging (periodicamente)
npm run db:sync-staging

# Backup antes de mudan√ßas importantes
npm run backup

# Reset banco de staging (se necess√°rio)
npm run db:reset-staging
```

---

## üìö PASSO 6: Scripts de Automa√ß√£o

### **6.1 - package.json - Adicionar Scripts**

```json
{
  "scripts": {
    "dev": "next dev",
    "dev:staging": "NODE_ENV=staging next dev",
    "build": "next build",
    "start": "next start",
    "db:migrate": "prisma migrate dev",
    "db:migrate:staging": "DATABASE_URL=$STAGING_DATABASE_URL prisma migrate dev",
    "db:sync-staging": "node scripts/sync-prod-to-staging.js",
    "db:reset-staging": "node scripts/reset-staging-db.js",
    "backup": "node scripts/backup.js",
    "backup:production": "node scripts/backup-production.js"
  }
}
```

### **6.2 - Script de Sincroniza√ß√£o**

Criar `scripts/sync-prod-to-staging.js`:

```javascript
#!/usr/bin/env node

const { exec } = require('child_process')

console.log('üîÑ SINCRONIZANDO PRODU√á√ÉO ‚Üí STAGING\n')

const PROD_URL = process.env.DATABASE_URL
const STAGING_URL = process.env.STAGING_DATABASE_URL

if (!PROD_URL || !STAGING_URL) {
  console.error('‚ùå URLs de banco n√£o configuradas')
  process.exit(1)
}

async function syncDatabases() {
  try {
    console.log('1Ô∏è‚É£ Fazendo backup da produ√ß√£o...')
    
    const backupCommand = `pg_dump "${PROD_URL}" --format=custom --no-owner --no-privileges --file=temp-prod-backup.sql`
    
    exec(backupCommand, (error, stdout, stderr) => {
      if (error) {
        console.error('‚ùå Erro no backup:', error)
        return
      }
      
      console.log('2Ô∏è‚É£ Restaurando no staging...')
      
      const restoreCommand = `pg_restore --verbose --clean --no-acl --no-owner -d "${STAGING_URL}" temp-prod-backup.sql`
      
      exec(restoreCommand, (error, stdout, stderr) => {
        if (error) {
          console.error('‚ùå Erro na restaura√ß√£o:', error)
          return
        }
        
        console.log('‚úÖ Sincroniza√ß√£o conclu√≠da!')
        console.log('üßπ Limpando arquivos tempor√°rios...')
        
        exec('rm -f temp-prod-backup.sql', () => {
          console.log('üéâ Staging atualizado com dados de produ√ß√£o!')
        })
      })
    })
    
  } catch (error) {
    console.error('‚ùå Erro na sincroniza√ß√£o:', error)
  }
}

syncDatabases()
```

---

## üìö PASSO 7: Configura√ß√£o de CI/CD

### **7.1 - GitHub Actions (Opcional)**

Criar `.github/workflows/staging.yml`:

```yaml
name: Deploy Staging

on:
  push:
    branches: [ staging ]
  pull_request:
    branches: [ staging ]

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests
      run: npm test
      env:
        DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
    
    - name: Build application
      run: npm run build
      env:
        DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
        NEXTAUTH_URL: https://dropa-colecion-veis-staging.vercel.app
```

### **7.2 - Configurar Secrets no GitHub**

1. **Ir para:** `Settings > Secrets and variables > Actions`
2. **Adicionar secrets:**
   - `STAGING_DATABASE_URL`
   - `STAGING_NEXTAUTH_SECRET`
   - Outros conforme necess√°rio

---

## üìö PASSO 8: Monitoramento e Logs

### **8.1 - Dashboard de Ambientes**

Criar `scripts/environment-status.js`:

```javascript
#!/usr/bin/env node

console.log('üìä STATUS DOS AMBIENTES\n')

const environments = {
  'Local Dev': {
    url: 'http://localhost:3000',
    database: process.env.DATABASE_URL?.includes('staging') ? 'staging' : 'production',
    branch: 'local'
  },
  'Staging': {
    url: 'https://dropa-colecion-veis-staging.vercel.app',
    database: 'staging',
    branch: 'staging'
  },
  'Production': {
    url: 'https://dropa-colecion-veis.vercel.app',
    database: 'production',
    branch: 'main'
  }
}

Object.entries(environments).forEach(([name, config]) => {
  console.log(`üåê ${name}:`)
  console.log(`   URL: ${config.url}`)
  console.log(`   Database: ${config.database}`)
  console.log(`   Branch: ${config.branch}`)
  console.log('')
})

console.log('üîß COMANDOS √öTEIS:')
console.log('   npm run dev              # Desenvolvimento local')
console.log('   npm run db:sync-staging  # Sincronizar dados')
console.log('   npm run backup           # Backup local')
console.log('   git checkout staging     # Mudar para staging')
console.log('   git checkout main        # Mudar para produ√ß√£o')
```

---

## üìö PASSO 9: Checklist de Implementa√ß√£o

### **‚úÖ Tarefas de Configura√ß√£o**

#### **Supabase:**
- [ ] Verificar banco `dropa-staging` existe
- [ ] Copiar dados de produ√ß√£o para staging
- [ ] Configurar usu√°rios e permiss√µes
- [ ] Testar conex√£o

#### **GitHub:**
- [ ] Criar branch `staging`
- [ ] Configurar protection rules
- [ ] Configurar secrets para CI/CD
- [ ] Testar workflow

#### **Vercel Staging:**
- [ ] Configurar vari√°veis de ambiente
- [ ] Conectar branch `staging`
- [ ] Testar deploy autom√°tico
- [ ] Verificar funcionamento

#### **Vercel Produ√ß√£o:**
- [ ] Verificar configura√ß√µes atuais
- [ ] Confirmar branch `main`
- [ ] Validar vari√°veis de produ√ß√£o
- [ ] Testar deploy

#### **Local:**
- [ ] Criar `.env.local`
- [ ] Configurar banco staging
- [ ] Testar desenvolvimento local
- [ ] Configurar scripts npm

---

## üìö PASSO 10: Comandos de Execu√ß√£o

### **10.1 - Ordem de Implementa√ß√£o**

```bash
# 1. Configurar vari√°veis locais
cp .env .env.production.backup
# Editar .env.local com configura√ß√µes de staging

# 2. Configurar branches
git checkout -b staging
git push -u origin staging

# 3. Testar desenvolvimento local
npm run dev
# Verificar se conecta no banco staging

# 4. Configurar Vercel Staging
# Acessar dashboard e configurar vari√°veis

# 5. Testar deploy staging
git add .
git commit -m "feat: configurar ambiente staging"
git push origin staging

# 6. Verificar funcionamento
curl https://dropa-colecion-veis-staging.vercel.app/api/health

# 7. Configurar workflow de desenvolvimento
git checkout -b develop
git push -u origin develop
```

### **10.2 - Comandos de Manuten√ß√£o**

```bash
# Sincronizar dados periodicamente
npm run db:sync-staging

# Verificar status dos ambientes
node scripts/environment-status.js

# Backup antes de mudan√ßas importantes
npm run backup

# Limpar dados de teste no staging
npm run db:reset-staging
```

---

## üìö RESUMO EXECUTIVO

### **üéØ Benef√≠cios da Separa√ß√£o:**

‚úÖ **Seguran√ßa:** Desenvolvimento n√£o afeta produ√ß√£o  
‚úÖ **Testes:** Ambiente seguro para homologa√ß√£o  
‚úÖ **Rollback:** Facilita revers√£o de mudan√ßas  
‚úÖ **Performance:** Otimiza√ß√£o independente  
‚úÖ **Compliance:** Boas pr√°ticas de DevOps  

### **üîß Estrutura Final:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Ambiente    ‚îÇ Banco            ‚îÇ Branch/Deploy   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Local Dev   ‚îÇ dropa-staging    ‚îÇ feature/*       ‚îÇ
‚îÇ Staging     ‚îÇ dropa-staging    ‚îÇ staging         ‚îÇ
‚îÇ Production  ‚îÇ dropa            ‚îÇ main            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **üöÄ Workflow:**

```
feature/nova ‚Üí staging ‚Üí main
     ‚Üì           ‚Üì        ‚Üì
  Local Dev ‚Üí Staging ‚Üí Production
     ‚Üì           ‚Üì        ‚Üì
 dropa-staging ‚Üí dropa-staging ‚Üí dropa
```

---

**üéâ Com essa configura√ß√£o, voc√™ ter√° um ambiente de desenvolvimento profissional, seguro e escal√°vel!**